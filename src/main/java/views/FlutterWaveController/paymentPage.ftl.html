<#import "../layout/defaultLayout.ftl.html" as layout>
<@layout.myLayout "BytePay">
    <#include "../layout/header.ftl.html"/>
    <script src="https://api.ravepay.co/flwv3-pug/getpaidx/api/flwpbf-inline.js"></script>
    <#--<div class="row">-->

    <#--</div>-->
    <br><br>

    <!-- Start Form Area -->
    <section class="featured-area">
        <div class="container" style="padding: 20px;border: 2px solid #28a74540;border-radius: 10px;">
            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <#--<#if (paymentbooking ??)>-->
                    <div class="mt-10">
                        <!-- Notifications -->

                        <#-- <div class="alert alert-warning">
                             <a href="#" class="close" data-dismiss="alert">&times;</a>
                             <strong><i class="fa fa-info-circle"></i></strong> Find payment details below.
                         </div>-->
                        <!-- End Notifications -->
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div><h2 style="color: darkgreen"> BW PAY </h2></div>
                        </div>

                        <div class="col-md-4">
                            <div class="dashboard-breadcrumb">
                                <a href="http://staging.ncbs.ng/ncbs-pay/payment/start" title="Go back to Your Payment Page">Online Payment Portal</a>
                                &nbsp;>&nbsp;
                                <span>Transaction Details</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <#if error??>
                        <div class="alert alert-warning text-center">
                            <b>${error}</b>
                        </div>
                    </#if>
                    <#if data?? && transactionData??>
                        <div class="col-md-8 offset-md-2 card mt-5">

                            <div class="row m-5">
                                <div class="col-12">

                                    <table class="table table-striped table-bordered" style="width: 100%">
                                        <h3 class="text-center">ORDER DETAILS</h3>
                                        <tr hidden>
                                            <th style="width: 40%;">Payment reference</th>
                                            <td id="ppr">${transactionData.merchantTransactionReferenceId!""}</td>
                                        </tr>
                                        <tr>
                                            <th style="width: 40%;">Transaction Reference</th>
                                            <td id="tRef">${data.transactionReference!""}</td>
                                        </tr>


                                        <tr>
                                            <th style="width: 40%;">Name</th>
                                            <td id="customerName">${data.customerFirstname} ${data.customerLastname}</td>
                                        </tr>
                                        <#if transactionData.payer??>
                                            <tr>
                                                <th style="width: 40%;">Email</th>
                                                <td id="customerEmail">${transactionData.payer.email!""}</td>
                                            </tr>
                                        </#if>
                                        <tr>
                                            <th style="width: 30%;">Amount</th>
                                             <td id="amountPaid">${data.amount/100}</td>
                                        </tr>
                                        <tr hidden>
                                            <th style="width: 40%;">Redirect Url</th>
                                            <td id="redirectUrl" hidden>${data.redirectUrl}</td>
                                        </tr>
                                    </table>
                                </div>
                                <form>
                                    <button type="button" onClick="payWithRave()">Proceed</button>
                                </form>
                            </div>
                            <div class="modal-header">

                            </div>


                        </div>
                    </#if>
                </div>
            </div>
        </div>
    </section>

    <br><br>

    <script>
        var API_publicKey = "FLWPUBK_TEST-f3fab41f74c525c394562d925d82c8f1-X";

        function payWithRave() {
            var prr = document.getElementById('ppr').textContent;
            var tRef = document.getElementById('tRef').textContent;
            var custRef = document.getElementById('customerEmail').textContent;
            var amountPaid = document.getElementById('amountPaid').textContent;
            var redirectUrl = document.getElementById('redirectUrl').textContent;
            var x = getpaidSetup({
                PBFPubKey: API_publicKey,
                customer_email: document.getElementById('customerEmail').textContent,
                amount: document.getElementById('amountPaid').textContent,
                customer_phone: "08028584732",
                currency: "USD",
                txref: tRef,
                meta: [{
                    metaname: "flightID",
                    metavalue: "AP1234"
                }],
                onclose: function() {

                },
                callback: function(response) {
                    var txref = response.tx.txRef; // collect txRef returned and pass to a 					server page to complete status check.
                    console.log("This is the response returned after a charge", response);
                    if (
                        response.tx.chargeResponseCode == "00" ||
                        response.tx.chargeResponseCode == "0"
                    ) {
                        console.log(redirectUrl);
                       window.location.href= 'http://staging.ncbs.ng/ncbs-pay/rave/complete/' + tRef + '?redirectUrl=' + redirectUrl;
                    } else {
                        // redirect to a failure page.
                        window.location.href= 'http://staging.ncbs.ng/ncbs-pay/rave/complete/' + tRef + '?redirectUrl=' + redirectUrl;
                    }

                    x.close(); // use this to close the modal immediately after payment.
                }
            });
        }
    </script>

</@layout.myLayout>
